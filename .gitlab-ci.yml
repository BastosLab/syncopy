stages:
    - test
    - deploy

clusterTests:
    stage: test
    tags: 
    - slurm
    only:
    - master
    - dev
    variables:
        PYTEST_ADDOPTS: "--color=yes -q --tb=short"
    script:
    - source $HOME/miniconda3/bin/activate
    - pip install --upgrade pip
    - pip install --upgrade tox
    - srun -p DEV --mem=8000m -c 4 tox -r 

windowsTests:
    stage: test
    allow_failure: true
    tags: 
    - windows10
    only:
    - master
    - dev
    variables:
        PYTEST_ADDOPTS: "--color=yes -q --tb=short"
    script:
    - python -m pip install --upgrade --user pip
    - python -m pip install --upgrade --user tox
    - tox -r

deploy-to-testpypi:
    stage: deploy
    only:
    - master
    - tags    
    tags:
    - deploy
    script: 
    - source $HOME/miniconda/etc/profile.d/conda.sh
    - conda activate
    - conda update --yes conda
    - python setup.py sdist bdist_wheel
    - twine upload --repository testpypi dist/*
    
docs:
    stage: deploy
    tags:
    - docs
    only:
    - dev
    - master
    - tags
    
    script:
    - if hash $HOME/miniconda/bin/conda 2>/dev/null; 
      then
         export PATH="$HOME/miniconda/bin:$PATH";
      else
        wget http://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
        bash miniconda.sh -b -p $HOME/miniconda;
        export PATH="$HOME/miniconda/bin:$PATH";
      fi
    - source $HOME/miniconda/etc/profile.d/conda.sh
    - conda activate
    - conda update --yes conda
    - conda env update --file syncopy.yml
    - cd doc
    - make html
    - rsync -av -e "ssh" --delete build/html/* root@monitor:/var/www/html/syncopy
    - rsync -av -e "ssh" --delete build/html/* syncopy-docs:public_html/syncopy